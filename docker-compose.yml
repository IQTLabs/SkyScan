version: '3.7'

services:
  tracker:
    image: iqtlabs/skyscan-tracker
    command: "./flighttracker.py -m mqtt -H piaware -l ${LAT} -L ${LONG} -a ${ALT} -P skyscan/planes/json -T skyscan/flight/json -M ${MIN_ELEVATION} -c ${CAMERA_LEAD}"
    volumes:
      - ./data:/data
    ports:
      - 5000:5000
    depends_on:
      - mqtt
    restart: unless-stopped

  piaware:
    image: iqtlabs/skyscan-piaware
    tty: true
    container_name: piaware
    devices:
      - /dev/bus/usb:/dev/bus/usb
    ports:
      - 8080:80
      - 30003:30003
      - 30005:30005
    environment:
      - TZ=${TZ}
      - LAT=${LAT}
      - LONG=${LONG}
      - FEEDER_ID=${FEEDER_ID}
      - RECEIVER_TYPE=rtlsdr
      - DUMP1090_DEVICE=${RTL_DEV}
    restart: unless-stopped

  notebook:
    image: iqtlabs/skyscan-notebook-server
    ports:
        - "8888:8888"
    restart: unless-stopped
    depends_on:
      - mqtt

  mqtt:
    image: iqtlabs/edgetech-mqtt
    ports:
        - "9001:9001"
        - "1883:1883"
    restart: unless-stopped

  edge-detect:
    image: iqtlabs/skyscan-yolo
    volumes:
      - /flash/raw:/data/tosort
      - /flash/processed/plane:/data/plane
      - /flash/processed/log:/data/log
      - /flash/processed/noplane:/data/noplane
      - /flash/weights:/data/weights
    env_file:
      - .env
    depends_on:
      - mqtt

  proxy:
    image: jc21/nginx-proxy-manager:latest
    restart: unless-stopped
    ports:
      - 1337:80
      - 81:81
      - 443:443
    #network_mode: "host"
    volumes:
      - ./proxydata:/data
      - ./letsencrypt:/etc/letsencrypt

  axis-ptz:
    image: meadejs/skyscan-axis-ptz
    command: "./camera.py -f -m mqtt -t skyscan/flight/json -u ${AXIS_USERNAME} -p ${AXIS_PASSWORD} -a ${AXIS_IP} -z ${CAMERA_ZOOM} -s ${CAMERA_MOVE_SPEED} -d ${CAMERA_DELAY} --lat ${LAT} --lon ${LONG} --alt ${ALT} --roll ${ROLL} --pitch ${PITCH} --yaw ${YAW}"
    volumes:
      - /flash/raw:/app/capture
      - /flash/processed/log:/flash/processed/log
    depends_on:
      - mqtt
    restart: unless-stopped

